!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["Upload JS"]=t():e["Upload JS"]=t()}(window,function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);const s={textBtnUpload:"Ajouter un fichier",textBeforeUpload:"Aucun fichier sélectionné",textAfterUpload:"Vos fichiers",textSizeRest:"{{number}} restant{{s}}",textFileRest:"{{number}} fichier{{s}} restant{{s}}",textMaxFileSize:"{{number}} maximum par fichier",textFileNotValid:"Votre fichier n'est pas valide:",textMultipleFileNotValid:"Vos fichiers ne sont pas valides:",textFileTooBig:"Votre fichier est trop lourd:",textMultipleFileTooBig:"Vos fichiers sont trop lourd:",textTotalFilesSize:"Le poids total de vos fichiers est trop lourd.",textTooManyFiles:"Trop de fichiers téléchargés !",textTotalFiles:"La limite du nombre de fichier est atteinte",textErrorUpload:"Une erreur est survenue, impossible de télécharger le fichier."},r={textBtnUpload:"Add a file",textBeforeUpload:"No file selected",textAfterUpload:"Your files",textSizeRest:"{{number}} left",textFileRest:"{{number}} file{{s}} left",textMaxFileSize:"{{number}} maximum per file",textFileNotValid:"Your file is not valid",textMultipleFileNotValid:"Your file are not valid:",textFileTooBig:"Your file is too big",textMultipleFileTooBig:"Your files are too big",textTotalFilesSize:"Total files is too big",textTooManyFiles:"Too many files uploaded",textTotalFiles:"The limit has been reached",textErrorUpload:"Cannot upload the file"};i.d(t,"default",function(){return o});class n{constructor(){this.events={}}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){const i=this.events[e];i&&i.forEach(e=>{e.call(null,t)})}}class o extends n{constructor(e){super(),this.options={selector:'input[type="file"]',maxFileSize:2,maxTotalFilesSize:10,maxNbFiles:5,limitCharacters:10,displayMaxFileSize:!0,displayRestSize:!0,displayRestFiles:!0,displayFilenameError:!0,multiple:!0,mimeType:!1,fileExtensions:[".jpg",".jpeg",".png",".pdf"],dropZone:!1,actionAjax:null,language:"fr",languages:{},customContentOnly:!1,customContent:""},this.text=[],this.text.fr=s,this.text.en=r,this.options=Object.assign(this.options,e);const t=Object.keys(this.options.languages);t.length&&t.forEach((e,t)=>{this.text[e]?Object.assign(this.text[e],this.options.languages[e]):this._compareKeys(this.options.languages[e],s)&&(this.text[e]=this.options.languages[e])}),this.currentFiles=[],this.filesList=[],this.currentErrors=[],this.maxTotalFilesSize,this.wrapperFiles,this.parentInput,this.wrapperInput,this.wrapperInformation,this.filesContent,this.fileInput,this.wrapperBtnUpload,this.btnUpload,this.wrapperSelected,this.wrapperError,this.maxFileSize,this.restSize,this.restFiles,this.progressBar,this.progressBarContent}init(){if(this.maxTotalFilesSize=1048576*this.options.maxTotalFilesSize,this.fileInput=document.querySelector(this.options.selector),this.fileInput){if(this.parentInput=this.fileInput.parentNode,this.wrapperInput=document.createElement("div"),this.wrapperInput.classList.add("w-input"),this.wrapperBtnUpload=document.createElement("div"),this.wrapperBtnUpload.classList.add("w-input__upload"),this.btnUpload=document.createElement("span"),this.btnUpload.innerHTML=this.text[this.options.language].textBtnUpload,this.parentInput.replaceChild(this.wrapperInput,this.fileInput),this.wrapperInput.appendChild(this.fileInput),this.wrapperInput.appendChild(this.wrapperBtnUpload),this.options.customContent&&this.options.customContentOnly||this.wrapperBtnUpload.appendChild(this.btnUpload),this.options.customContent){const e=(new DOMParser).parseFromString(this.options.customContent,"text/xml");this.wrapperBtnUpload.appendChild(e.firstChild)}(this.options.displayRestSize||this.options.displayRestFiles||this.options.displayMaxFileSize)&&(this.wrapperInformation=document.createElement("div"),this.wrapperInformation.classList.add("w-information"),this.parentInput.appendChild(this.wrapperInformation),this.options.displayRestSize&&(this.restSize=document.createElement("div"),this.restSize.classList.add("w-information__size"),this.restSize.innerHTML=this._getText(this.text[this.options.language].textSizeRest,this._getRestSize()),this.wrapperInformation.appendChild(this.restSize)),this.options.displayMaxFileSize&&(this.maxFileSize=document.createElement("div"),this.maxFileSize.classList.add("w-information__size-max"),this.maxFileSize.innerHTML=this._getText(this.text[this.options.language].textMaxFileSize,this._getFileSize(1048576*this.options.maxFileSize)),this.wrapperInformation.appendChild(this.maxFileSize)),this.options.displayRestFiles&&(this.restFiles=document.createElement("div"),this.restFiles.classList.add("w-information__files"),this.restFiles.innerHTML=this._getText(this.text[this.options.language].textFileRest,this.options.maxNbFiles),this.wrapperInformation.appendChild(this.restFiles))),this.wrapperFiles=document.createElement("div"),this.wrapperFiles.classList.add("w-files"),this.parentInput.appendChild(this.wrapperFiles),this.wrapperSelected=document.createElement("span"),this.wrapperSelected.classList.add("w-files__selected"),this.wrapperSelected.innerHTML=this.text[this.options.language].textBeforeUpload,this.wrapperFiles.appendChild(this.wrapperSelected),this.options.actionAjax&&(this.progressBar=document.createElement("div"),this.progressBar.classList.add("w-progress-bar"),this.progressBarContent=document.createElement("div"),this.progressBarContent.classList.add("w-progress-bar__content"),this.progressBar.appendChild(this.progressBarContent),this.parentInput.appendChild(this.progressBar)),this.options.multiple&&this.fileInput.setAttribute("multiple",!0),this.options.fileExtensions.length&&this.fileInput.setAttribute("accept",this.options.fileExtensions),this.fileInput.addEventListener("change",this._addNewFile.bind(this)),this.wrapperBtnUpload.addEventListener("click",()=>{this.fileInput.click()},!1),this.options.dropZone?this._initDropZone():this.emit("init",{init:!0})}}_initDropZone(){let e=!1;this.wrapperBtnUpload.addEventListener("dragover",()=>{event.preventDefault(),this.parentInput.classList.add("is-dragover")},!1),this.wrapperBtnUpload.addEventListener("dragenter",()=>{this.parentInput.classList.add("is-dragover")},!1),this.wrapperBtnUpload.addEventListener("dragleave",()=>{this.parentInput.classList.remove("is-dragover")},!1),this.wrapperBtnUpload.addEventListener("dragend",()=>{this.parentInput.classList.remove("is-dragover")},!1),this.wrapperBtnUpload.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),this.parentInput.classList.remove("is-dragover"),e=t.dataTransfer.files,this._addNewFile(t,e)},!1),this.emit("init",{init:!0,initDropZone:!0})}_addNewFile(e,t=[]){this.currentFiles=[],this.currentErrors=[];let i=t.length?t:e.target.files?e.target.files:null;if(i){if(this.options.maxNbFiles&&this.options.maxNbFiles<i.length)return this.currentErrors.push({error:new Error("Limit files !").code="TOO_MANY_FILES",message:this.text[this.options.language].textTooManyFiles}),void this._displayError();if(this.options.maxNbFiles&&this.options.maxNbFiles===this.filesList.length||this.options.maxNbFiles<this.filesList.length+i.length)return this.currentErrors.push({error:new Error("Limit files !").code="TOO_MANY_FILES",message:this.text[this.options.language].textTotalFiles}),void this._displayError();if(Object.values(i).forEach((e,t)=>{const i=e.name.split(".").length>1?"."+e.name.split(".").pop().toLowerCase():null;this.options.fileExtensions.length&&-1===this.options.fileExtensions.indexOf(i)?this.currentErrors.push({error:new Error("Extension is not valid").code="EXTENSION",mimeType:i,file:e,message:this.text[this.options.language].textFileNotValid}):this._validSize(e)?this._validTotalSize(e)?this.currentFiles.push(e):this.currentErrors.push({error:new Error("Total size is too big").code="TOTAL_SIZE",file:e,fileSize:this._getFileSize(e.size),restSize:this._getRestSize(),message:this.text[this.options.language].textTotalFilesSize}):this.currentErrors.push({error:new Error("Size is too big").code="SIZE",file:e,fileSize:this._getFileSize(e.size),message:this.text[this.options.language].textFileTooBig})}),this.options.mimeType&&i.length===this.currentErrors.length&&this._displayError(),this.options.mimeType){let e=parseInt(1+this.currentErrors.length);this.currentFiles.forEach((t,s)=>{this._getFormat(escape(t.name),t,(s,r)=>{const n=this._getMimeType(r);this.options.fileExtensions.length&&!this._isValidMimeType(n)&&(this.currentErrors.push({error:new Error("Mime Type is not valid").code="EXTENSION",mimeType:this._getExtension(t.name),file:t,message:this.text[this.options.language].textFileNotValid}),this.currentFiles.splice(currentFiles.findIndex(e=>e.name===t.name),1)),i.length===e&&this._checkFiles(),e++})})}else this._checkFiles()}}_checkFiles(){if(!this._validTotalSize(null,this.currentFiles))return this.currentErrors.push({error:new Error("Total size is too big").code="TOTAL_SIZE_MULTIPLE",currentFiles:this.currentFiles,restSize:this._getRestSize(),message:this.text[this.options.language].textTotalFilesSize}),void this._displayError();this.currentFiles.length&&this._onSuccess(this.currentFiles),this.currentErrors.length&&this._displayError()}_onSuccess(){this.currentErrors.length||this._cleanError(),this.options.actionAjax?this._uploadFile(this.currentFiles):this._displayResult(this.currentFiles)}_displayResult(e){this.filesList=this.filesList.concat(e),this._displayFile(),this.emit("success",{currentFiles:e,files:this.filesList,errors:this.currentErrors})}_uploadFile(e){if(!this.progressBar)return;this.parentInput.classList.add("uploading"),this.progressBar.classList.add("active"),this.progressBarContent.style.width="0%";const t=new FormData;for(let i=0;i<e.length;i++)t.append(this.fileInput.getAttribute("name")+"["+i+"]",e[i]);const i=new XMLHttpRequest;i.open("POST",this.options.actionAjax),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.upload.addEventListener("progress",e=>{if(e.lengthComputable){let t=e.loaded/e.total;t=parseInt(100*t),this.progressBarContent.style.width=t+"%",100===t&&setTimeout(()=>{this.parentInput.classList.remove("uploading"),this.progressBar.classList.remove("active")},500)}}),i.onreadystatechange=t=>{4===i.readyState&&(200===i.status?this.displayResult(e):(progressBarContent.style.width="0%",this.currentErrors.push({error:new Error("Cannot upload file").code="UPLOAD",currentFiles:e,message:this.text[this.options.language].textErrorUpload}),this._displayError()))},i.send(t)}_displayFile(){this.filesContent?this.filesContent.innerHTML="":(this.filesContent=document.createElement("div"),this.filesContent.classList.add("w-files__content"),this.wrapperFiles.appendChild(this.filesContent)),this.filesList.length?this.wrapperSelected.innerHTML=this.text[this.options.language].textAfterUpload:this.wrapperSelected.innerHTML=this.text[this.options.language].textBeforeUpload,this.restSize&&(this.restSize.innerHTML=this._getText(this.text[this.options.language].textSizeRest,this._getRestSize())),this.restFiles&&(this.restFiles.innerHTML=this._getText(this.text[this.options.language].textFileRest,this.options.maxNbFiles-this.filesList.length)),this.filesList.forEach(e=>{let t=document.createElement("div");t.classList.add("file"),t.innerHTML='<span class="file__delete"></span><span class="file__name">'+this._getFileName(e.name)+'</span><span class="file__size">('+this._getFileSize(e.size)+")</span>",this.filesContent.appendChild(t),t.querySelector(".file__delete").addEventListener("click",this._removeFile.bind(this))})}_removeFile(e){const t=Array.prototype.slice.call(this.filesContent.children).indexOf(e.target.parentNode),i=this.filesList[t];this.filesList.splice(t,1),this._displayFile(),this.emit("delete",{file:i,filesList:this.filesList})}_cleanError(){this.parentInput&&this.parentInput.classList.remove("error-upload"),this.wrapperError&&this.wrapperError.parentNode&&this.wrapperError.parentNode.removeChild(this.wrapperError)}_getFormat(e,t,i){var s=new FileReader;this.parentInput.classList.add("loading"),s.onloadend=t=>{for(var s=new Uint8Array(t.target.result).subarray(0,4),r="",n=0;n<s.length;n++)r+=s[n].toString(16);this.parentInput.classList.remove("loading"),i(e,r)},s.readAsArrayBuffer(t)}_getExtension(e){return e.split(".").length>1?"."+e.split(".").pop().toLowerCase():null}_getMimeType(e){let t="";switch(e){case"89504e47":t=".png";break;case"47494638":t=".gif";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":t=".jpeg";break;case"ffd8ffdb":case"ffd8ffee":t=".jpg";break;case"41647265":t=".txt";break;case"25504446":t=".pdf";break;case"504b34":case"504b0304":t=[".zip",".xlsx",".pptx",".docx"];break;default:t="unknown"}return t}_isValidMimeType(e){if(Array.isArray(e)){for(let t=0;t<=e.length;t++)if(-1!==this.options.fileExtensions.indexOf(e[t]))return!0;return!1}return-1!==this.options.fileExtensions.indexOf(e)}_validSize(e){return e.size/1024/1024<this.options.maxFileSize}_validTotalSize(e=null,t=this.filesList){return Math.round(this.maxTotalFilesSize)>=this._getTotalSize(e,t)}_getText(e,t){return"string"==typeof t&&t.match(/\d+/)[0]>1||"number"==typeof t&&t>1?e.replace(/{{number}}/g,t).replace(/{{s}}/g,"s"):e.replace(/{{number}}/g,t).replace(/{{s}}/g,"")}_getRestSize(e=this.filesList){return this._getFileSize(this.maxTotalFilesSize-this._getTotalSize(null,e))}_getTotalSize(e,t){let i=0;if(t.length)for(let e in t)i+=t[e].size;return e&&(i+=e.size),i}_getFileSize(e){let t=new Array("Octets","Ko","Mo","Go"),i=0;for(;e>900;)e/=1024,i++;return Math.round(100*e)/100+" "+t[i]}_getFileName(e){let t=e.split(".").pop();return e.length-t.length-1>this.options.limitCharacters&&(e=e.substr(0,this.options.limitCharacters)+"(...)."+t),e}_getFormData(e){let t=new FormData(e[0]);for(let e=0;e<this.filesList.length;e++)t.append(fileInput.getAttribute("name")+"["+e+"]",this.filesList[e]);return t}update(e){this.fileInput&&e&&Object.keys(e).length&&(1===Object.keys(e).length&&e.language?o.language=e.language:this.reset(e))}reset(e={}){this.filesList=[],this.fileInput.value="",this.wrapperInformation&&(this._cleanError(),this.wrapperInformation.remove(),this.wrapperFiles&&this.wrapperFiles.remove(),this.filesContent=""),this.wrapperBtnUpload&&this.wrapperBtnUpload.remove(),this.init(e)}_clear(){this.wrapperInformation&&(this.filesList=[],this._cleanError(),this._displayFile())}_displayError(){if(this.wrapperInformation){this._cleanError(),this.wrapperError=document.createElement("div"),this.wrapperError.classList.add("w-information__error");const e=this.currentErrors.filter(e=>"SIZE"===e.error);if(e.length){let t=document.createElement("span"),i=1===e.length?this.text[this.options.language].textFileTooBig:this.text[this.options.language].textMultipleFileTooBig;this.options.displayFilenameError&&e.forEach((e,t)=>{i+=t?", "+this._getFileName(e.file.name):" "+this._getFileName(e.file.name)}),t.innerHTML=i,this.wrapperError.appendChild(t)}const t=this.currentErrors.filter(e=>"EXTENSION"===e.error);if(t.length){let e=document.createElement("span"),i=1===t.length?this.text[this.options.language].textFileNotValid:this.text[this.options.language].textMultipleFileNotValid;this.options.displayFilenameError&&t.forEach((e,t)=>{i+=t?", "+this._getFileName(e.file.name):" "+this._getFileName(e.file.name)}),e.innerHTML=i,this.wrapperError.appendChild(e)}this.currentErrors.forEach(e=>{if("EXTENSION"!==e.error&&"SIZE"!==e.error){let t=document.createElement("span");t.innerHTML=e.message,this.wrapperError.appendChild(t)}}),this.wrapperInformation.appendChild(this.wrapperError),this.parentInput.classList.add("error-upload")}this.emit("error",{errors:this.currentErrors})}_compareKeys(e,t){var i=Object.keys(e).sort(),s=Object.keys(t).sort();return JSON.stringify(i)===JSON.stringify(s)}get files(){return this.filesList}set language(e){e&&this.options.language!==e&&this.fileInput&&(this.options.language=e,this._cleanError(),this.filesList.length?this.wrapperSelected.innerHTML=this.text[this.options.language].textAfterUpload:this.wrapperSelected.innerHTML=this.text[this.options.language].textBeforeUpload,this.options.displayRestSize&&(this.restSize.innerHTML=this._getText(this.text[this.options.language].textSizeRest,this._getRestSize())),this.options.displayMaxFileSize&&(this.maxFileSize.innerHTML=this._getText(this.text[this.options.language].textMaxFileSize,this._getFileSize(1048576*this.options.maxFileSize))),this.options.displayRestFiles&&(this.restFiles.innerHTML=this._getText(this.text[this.options.language].textFileRest,this.options.maxNbFiles)))}}}])});